name: Discord PR Events

on:
  pull_request:
    types: [opened, closed]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord Notification (Premium Layout)
        env:
          WEBHOOK: ${{ secrets.DISCORD_URL_PR_WEBHOOK }}
        run: |
          set -e

          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"

          TITLE=""
          DESCRIPTION=""
          URL=""
          COLOR=5793266
          AUTHOR=""
          AUTHOR_ICON=""
          FIELDS="[]"

          # ===== Pull Request Events =====
          if [ "$EVENT" = "pull_request" ]; then
            TITLE_PR="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            AUTHOR_ICON="${{ github.event.pull_request.user.avatar_url }}"
            BASE="${{ github.event.pull_request.base.ref }}"
            HEAD="${{ github.event.pull_request.head.ref }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"

            if [ "$ACTION" = "opened" ]; then
              TITLE="üÜï Pull Request Aberto"
              COLOR=3066993
            fi

            if [ "$ACTION" = "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                TITLE="üéâ Pull Request Mergeado"
                COLOR=15844367
              else
                TITLE="‚ùå Pull Request Fechado"
                COLOR=15158332
              fi
            fi

            DESCRIPTION="**$TITLE_PR**"

            FIELDS=$(jq -n \
              --arg pr "#$PR_NUMBER" \
              --arg branch "$HEAD ‚Üí $BASE" \
              --arg repo "$REPO" \
              '[
                { "name": "üî¢ PR", "value": $pr, "inline": true },
                { "name": "üåø Branch", "value": $branch, "inline": true },
                { "name": "üì¶ Reposit√≥rio", "value": $repo, "inline": true }
              ]')
          fi

          # ===== Comment on Pull Request =====
          if [ "$EVENT" = "issue_comment" ]; then
            if [ "${{ github.event.issue.pull_request }}" = "" ]; then
              echo "Coment√°rio n√£o √© em PR. Ignorando."
              exit 0
            fi

            TITLE="üí¨ Novo Coment√°rio em Pull Request"
            DESCRIPTION="${{ github.event.comment.body }}"
            URL="${{ github.event.comment.html_url }}"
            AUTHOR="${{ github.event.comment.user.login }}"
            AUTHOR_ICON="${{ github.event.comment.user.avatar_url }}"
            COLOR=3447003

            FIELDS=$(jq -n \
              --arg repo "$REPO" \
              '[
                { "name": "üì¶ Reposit√≥rio", "value": $repo, "inline": true }
              ]')
          fi

          # ===== Pull Request Review =====
          if [ "$EVENT" = "pull_request_review" ]; then
            TITLE_PR="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.review.user.login }}"
            AUTHOR_ICON="${{ github.event.review.user.avatar_url }}"
            STATE="${{ github.event.review.state }}"

            case "$STATE" in
              approved)
                STATE_LABEL="‚úÖ Approved"
                COLOR=3066993
                ;;
              changes_requested)
                STATE_LABEL="üîÑ Changes Requested"
                COLOR=15158332
                ;;
              commented)
                STATE_LABEL="üí¨ Commented"
                COLOR=10181046
                ;;
              *)
                STATE_LABEL="$STATE"
                COLOR=5793266
                ;;
            esac

            TITLE="üßê Code Review"
            DESCRIPTION="**$TITLE_PR**"

            FIELDS=$(jq -n \
              --arg state "$STATE_LABEL" \
              --arg repo "$REPO" \
              '[
                { "name": "üìã Status do Review", "value": $state, "inline": true },
                { "name": "üì¶ Reposit√≥rio", "value": $repo, "inline": true }
              ]')
          fi

          # ===== Send Discord Embed =====
          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESCRIPTION" \
            --arg url "$URL" \
            --arg author "$AUTHOR" \
            --arg icon "$AUTHOR_ICON" \
            --argjson color $COLOR \
            --argjson fields "$FIELDS" \
            '{
              username: "Bar√£o pisado",
              avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              embeds: [{
                title: $title,
                url: $url,
                description: $desc,
                color: $color,
                author: {
                  name: $author,
                  icon_url: $icon
                },
                fields: $fields,
                footer: {
                  text: "GitHub ‚Ä¢ Pull Request Automation"
                },
                timestamp: (now | todate)
              }]
            }' | curl -s -X POST -H "Content-Type: application/json" -d @- "$WEBHOOK"
