name: Discord PR Events

on:
  pull_request:
    types: [opened, closed]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord Notification
        env:
          DISCORD_URL_PR_WEBHOOK: ${{ secrets.DISCORD_URL_PR_WEBHOOK }}
        run: |
          EVENT="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          REPO="${{ github.repository }}"

          COLOR=5793266 # default azul
          TITLE=""
          DESCRIPTION=""
          URL=""
          AUTHOR=""
          AUTHOR_ICON=""

          if [ "$EVENT" = "pull_request" ]; then
            TITLE_PR="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            AUTHOR_ICON="${{ github.event.pull_request.user.avatar_url }}"

            if [ "$ACTION" = "opened" ]; then
              TITLE="üÜï Novo Pull Request"
              DESCRIPTION="**$TITLE_PR**"
              COLOR=3066993
            fi

            if [ "$ACTION" = "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                TITLE="üéâ Pull Request Mergeado"
                DESCRIPTION="**$TITLE_PR**"
                COLOR=15844367
              else
                TITLE="‚ùå Pull Request Fechado"
                DESCRIPTION="**$TITLE_PR**"
                COLOR=15158332
              fi
            fi
          fi

          if [ "$EVENT" = "issue_comment" ]; then
            if [ "${{ github.event.issue.pull_request }}" != "" ]; then
              TITLE="üí¨ Novo Coment√°rio em PR"
              DESCRIPTION="${{ github.event.comment.body }}"
              URL="${{ github.event.comment.html_url }}"
              AUTHOR="${{ github.event.comment.user.login }}"
              AUTHOR_ICON="${{ github.event.comment.user.avatar_url }}"
              COLOR=3447003
            else
              exit 0
            fi
          fi

          if [ "$EVENT" = "pull_request_review" ]; then
            STATE="${{ github.event.review.state }}"
            TITLE_PR="${{ github.event.pull_request.title }}"
            URL="${{ github.event.pull_request.html_url }}"
            AUTHOR="${{ github.event.review.user.login }}"
            AUTHOR_ICON="${{ github.event.review.user.avatar_url }}"

            TITLE="üßê Review em Pull Request"
            DESCRIPTION="**$TITLE_PR**\nüìã Status: **$STATE**"
            COLOR=10181046
          fi

          curl -X POST -H "Content-Type: application/json" \
          -d "{
            \"username\": \"Bar√£o pisado\",
            \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"url\": \"$URL\",
              \"description\": \"$DESCRIPTION\",
              \"color\": $COLOR,
              \"author\": {
                \"name\": \"$AUTHOR\",
                \"icon_url\": \"$AUTHOR_ICON\"
              },
              \"footer\": {
                \"text\": \"$REPO\"
              }
            }]
          }" \
          $DISCORD_URL_PR_WEBHOOK

